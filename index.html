<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dfamo - Homework Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
      body {
        background: linear-gradient(270deg, #000000, #0a0a0a, #101820, #000000);
        background-size: 800% 800%;
        animation: gradientShift 20s ease infinite;
        color: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease forwards;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .glow-btn:hover {
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        transform: scale(1.03);
      }

      .active-option {
        background: linear-gradient(to right, #00bcd4, #ff4081);
        color: white;
      }

      .slide {
        transition: all 0.5s ease;
      }

      .footer-glow {
        background: rgba(30, 30, 30, 0.98);
        border-top: 2px solid rgba(0, 188, 212, 0.5);
        box-shadow: 0 -5px 30px rgba(0, 255, 255, 0.3);
        animation: footerPulse 3s ease-in-out infinite alternate;
      }

      @keyframes footerPulse {
        from { box-shadow: 0 -5px 30px rgba(0,255,255,0.3); }
        to { box-shadow: 0 -5px 30px rgba(255,105,180,0.4); }
      }

      .dfamo-title {
        background: linear-gradient(to right, #bfbfbf, #e0e0e0, #7f7f7f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .math-solution {
        text-align: left;
        line-height: 1.8;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .math-solution strong {
        color: #00bcd4;
        font-weight: 600;
      }

      .math-solution p {
        margin-bottom: 1rem;
      }

      #Solution:empty::after {
        content: 'Your solution will appear here...';
        color: #666;
        font-style: italic;
      }

      .pencil-emoji {
        position: absolute;
        top: -55px;
        right: 80px;
        font-size: 3rem;
        transform: rotate(90deg);
        transition: all 0.3s ease;
        z-index: 10;
        opacity: 0;
      }

      .pencil-emoji.animating {
        animation: pencilWrite 5s ease-in-out forwards;
        opacity: 1;
      }

      @keyframes pencilWrite {
        0% {
          transform: translateX(0) translateY(0) rotate(90deg);
          opacity: 1;
        }
        5% {
          transform: translateX(-50px) translateY(300px) rotate(45deg);
          opacity: 1;
        }
        15% {
          transform: translateX(30px) translateY(350px) rotate(60deg);
          opacity: 1;
        }
        25% {
          transform: translateX(-80px) translateY(400px) rotate(30deg);
          opacity: 1;
        }
        35% {
          transform: translateX(50px) translateY(450px) rotate(70deg);
          opacity: 1;
        }
        45% {
          transform: translateX(-40px) translateY(500px) rotate(40deg);
          opacity: 1;
        }
        55% {
          transform: translateX(60px) translateY(550px) rotate(65deg);
          opacity: 1;
        }
        65% {
          transform: translateX(-70px) translateY(600px) rotate(35deg);
          opacity: 1;
        }
        75% {
          transform: translateX(40px) translateY(650px) rotate(55deg);
          opacity: 1;
        }
        85% {
          transform: translateX(-30px) translateY(500px) rotate(50deg);
          opacity: 1;
        }
        92% {
          transform: translateX(0px) translateY(200px) rotate(80deg);
          opacity: 1;
        }
        96% {
          transform: translateX(0) translateY(50px) rotate(85deg);
          opacity: 1;
        }
        100% {
          transform: translateX(0) translateY(0) rotate(90deg);
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        .pencil-emoji {
          font-size: 2rem;
          top: -40px;
          right: 50px;
        }

        @keyframes pencilWrite {
          0% {
            transform: translateX(0) translateY(0) rotate(90deg);
            opacity: 1;
          }
          5% {
            transform: translateX(-30px) translateY(200px) rotate(45deg);
            opacity: 1;
          }
          15% {
            transform: translateX(20px) translateY(250px) rotate(60deg);
            opacity: 1;
          }
          25% {
            transform: translateX(-50px) translateY(300px) rotate(30deg);
            opacity: 1;
          }
          35% {
            transform: translateX(30px) translateY(350px) rotate(70deg);
            opacity: 1;
          }
          45% {
            transform: translateX(-25px) translateY(400px) rotate(40deg);
            opacity: 1;
          }
          55% {
            transform: translateX(35px) translateY(450px) rotate(65deg);
            opacity: 1;
          }
          65% {
            transform: translateX(-40px) translateY(500px) rotate(35deg);
            opacity: 1;
          }
          75% {
            transform: translateX(25px) translateY(550px) rotate(55deg);
            opacity: 1;
          }
          85% {
            transform: translateX(-20px) translateY(400px) rotate(50deg);
            opacity: 1;
          }
          92% {
            transform: translateX(0px) translateY(150px) rotate(80deg);
            opacity: 1;
          }
          96% {
            transform: translateX(0) translateY(40px) rotate(85deg);
            opacity: 1;
          }
          100% {
            transform: translateX(0) translateY(0) rotate(90deg);
            opacity: 0;
          }
        }
      }
      
      .listening-pulse {
  animation: pulse 1.5s ease-in-out infinite;
  background: linear-gradient(to right, #ef4444, #dc2626) !important;
}

@keyframes pulse {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1); 
  }
  50% { 
    opacity: 0.7; 
    transform: scale(1.1); 
  }
}

.mic-listening {
  background: linear-gradient(to right, #ef4444, #dc2626);
}

    </style>
  </head>
  <body>
    <div class="min-h-screen flex flex-col">
      <header class="fixed top-0 left-0 w-full z-50 backdrop-blur-xl bg-black/40 border-b border-white/10 flex justify-between items-center px-6 py-3 fade-in">
        <div class="flex items-center gap-3">
          <img src="http://dfamo.foilai.in/logo.png" class="w-10 h-10 rounded-xl" alt="DfamoAI Logo" />
          <h1 class="text-cyan-300 text-sm sm:text-base font-light">Version: Alpha (0.0.9)</h1>
        </div>

        <a
          href="https://foilai.in"
          target="_blank"
          rel="noopener noreferrer"
          class="backdrop-blur-xl bg-white/10 rounded-xl border border-white/10 px-3 py-2 flex items-center space-x-2 transition-all duration-300 hover:scale-105 hover:bg-pink-500/20 hover:border-pink-500/50 glow-btn"
        >
          <img src="http://dfamo.foilai.in/foilailogo.jpg" alt="FoilAI Logo" class="w-8 h-8 rounded-lg object-cover" />
          <span class="text-white text-sm font-medium">FoilAI.in</span>
        </a>
      </header>

      <main class="flex-grow flex flex-col items-center justify-center text-center pt-28 pb-10 w-full fade-in px-4">
        <div class="relative">
          <div id="pencilEmoji" class="pencil-emoji">✏️</div>
          <h1 class="dfamo-title text-6xl sm:text-7xl md:text-8xl font-extrabold mb-4 animate-pulse">Dfamo</h1>
        </div>
        <p class="text-gray-300 mb-10 text-lg sm:text-xl">Homework done in seconds ⚡</p>

        <div class="flex gap-4 mb-6">
  <button id="textModeBtn" class="px-4 py-2 rounded-xl transition-all duration-300 active-option">
    Text
  </button>
  <button id="imageModeBtn" class="px-4 py-2 rounded-xl transition-all duration-300 bg-white/10 hover:bg-white/20">
    Image
  </button>
  <!-- ADD THIS NEW BUTTON -->
  <button id="audioModeBtn" class="px-4 py-2 rounded-xl transition-all duration-300 bg-white/10 hover:bg-white/20">
    Audio
  </button>
</div>


        <div class="w-full max-w-2xl fade-in">
          <div id="textInputContainer" class="slide">
            <input
              id="questionInput"
              type="text"
              placeholder="Enter your question..."
              class="w-full bg-white/10 text-white font-medium py-4 px-6 rounded-2xl focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-300"
            />
          </div>

          <div id="imageInputContainer" class="slide border-2 border-dashed border-gray-500 rounded-2xl p-8 text-gray-300 bg-white/5 mt-2" style="display: none;">
            <label for="imageUpload" class="cursor-pointer block text-center hover:text-cyan-400 transition">
              <span id="uploadLabel">
                Drag & Drop or <span class="text-pink-400 underline">Upload Image</span>
              </span>
              <input
                id="imageUpload"
                type="file"
                accept="image/*"
                class="hidden"
              />
            </label>
            <p id="extractedTextInfo" class="text-sm mt-4 text-gray-400" style="display: none;">
              Extracted text will be used for the solution
            </p>
          </div>
<!-- Add this after imageInputContainer -->
<div id="audioInputContainer" class="slide border-2 border-dashed border-gray-500 rounded-2xl p-8 text-gray-300 bg-white/5 mt-2" style="display: none;">
  <div class="flex flex-col items-center gap-4">
    <button id="micButton" class="p-6 rounded-full transition-all duration-300 bg-gradient-to-r from-cyan-500 to-pink-500 hover:shadow-lg">
      <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
        <line x1="12" x2="12" y1="19" y2="22"></line>
      </svg>
    </button>
    <p id="listeningStatus" class="text-center">Click the microphone to start speaking</p>
    <div id="transcriptDisplay" class="w-full mt-4 p-4 bg-white/10 rounded-xl" style="display: none;">
      <p class="text-sm text-gray-400 mb-2">Transcript:</p>
      <p id="transcriptText" class="text-white"></p>
    </div>
  </div>
</div>

          <div class="mt-6 flex gap-3">
            <button
              id="submitBtn"
              class="flex-1 bg-gradient-to-r from-cyan-500 via-pink-500 to-yellow-500 text-white font-bold py-3 rounded-2xl transition duration-300 glow-btn"
            >
              SUBMIT
            </button>
            <button
              id="refreshBtn"
              class="bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold py-3 px-6 rounded-2xl transition duration-300 hover:from-gray-700 hover:to-gray-800 flex items-center justify-center"
              title="Clear all"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
              </svg>
            </button>
          </div>
        </div>

        <section class="w-full max-w-2xl mt-10 fade-in">
          <div class="backdrop-blur-xl bg-black/70 rounded-3xl border border-white/10 shadow-2xl p-6">
            <p class="text-center text-white font-bold text-lg mb-4">SOLUTION</p>
            <div id="Solution" class="math-solution text-gray-300"></div>
          </div>
        </section>
      </main>

      <footer class="w-full footer-glow py-6 text-center text-sm fade-in mt-auto">
        <p class="text-cyan-300">
          Created by <span class="font-semibold text-cyan-400">
            <a href="https://instagram.com/real.foil" target="_blank" rel="noopener noreferrer">Aryansh Rai</a>
          </span> | AI Partner - <a href="https://pollinations.ai" target="_blank" rel="noopener noreferrer" class="font-semibold text-pink-400 hover:text-pink-300 transition">Pollinations AI</a>
        </p>
        <p class="text-cyan-300/70 mt-2">© Dfamo. All rights reserved.</p>
      </footer>
    </div>

    <script>
      // State management
      let mode = 'text';
      let question = '';
      let solution = '';
      let isLoading = false;
      let countdown = 0;
      let selectedFile = null;
      let isProcessingImage = false;
      let countdownInterval = null;

      // DOM elements
      const textModeBtn = document.getElementById('textModeBtn');
      const imageModeBtn = document.getElementById('imageModeBtn');
      const textInputContainer = document.getElementById('textInputContainer');
      const imageInputContainer = document.getElementById('imageInputContainer');
      const questionInput = document.getElementById('questionInput');
      const imageUpload = document.getElementById('imageUpload');
      const uploadLabel = document.getElementById('uploadLabel');
      const extractedTextInfo = document.getElementById('extractedTextInfo');
      const submitBtn = document.getElementById('submitBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const solutionDiv = document.getElementById('Solution');
      const pencilEmoji = document.getElementById('pencilEmoji');
      const audioModeBtn = document.getElementById('audioModeBtn');
      const audioInputContainer = document.getElementById('audioInputContainer');


      // Clean OCR text function
      function cleanOCRText(text) {
        let cleaned = text;

        cleaned = cleaned.replace(/V(\d+)/g, '√$1');
        cleaned = cleaned.replace(/v(\d+)/g, '√$1');
        cleaned = cleaned.replace(/\bsqrt\s*\(?(\d+)\)?/gi, '√$1');

        cleaned = cleaned.replace(/(\d+)\s*\/\s*(\d+)(?!\d)/g, (match, num, denom) => {
          const hasRootBefore = cleaned.substring(Math.max(0, cleaned.indexOf(match) - 10), cleaned.indexOf(match)).includes('√');
          if (hasRootBefore && parseInt(denom) <= 9) {
            return `√${denom}`;
          }
          return `${num}/${denom}`;
        });

        const rootPattern = /(\d+)\s*[-+]\s*(\d+)√(\d+)/g;
        const matches = [...cleaned.matchAll(rootPattern)];
        if (matches.length > 0) {
          cleaned = cleaned.replace(/(\d+)\s*[+]\s*(\d+)\/(\d+)/g, (match, base, num, denom) => {
            const matchPos = cleaned.indexOf(match);
            const beforeText = cleaned.substring(0, matchPos);
            if (beforeText.includes('√')) {
              return `${base} + ${num}√${denom}`;
            }
            return match;
          });

          cleaned = cleaned.replace(/(\d+)\s*[-]\s*(\d+)\/(\d+)/g, (match, base, num, denom) => {
            const matchPos = cleaned.indexOf(match);
            const beforeText = cleaned.substring(0, matchPos);
            if (beforeText.includes('√')) {
              return `${base} - ${num}√${denom}`;
            }
            return match;
          });
        }

        cleaned = cleaned.replace(/\s*\*\s*/g, '×');
        cleaned = cleaned.replace(/\b([a-z])\s*\^\s*(\d+)/gi, '$1^$2');
        cleaned = cleaned.replace(/\b([a-z])\s*\*\*\s*(\d+)/gi, '$1^$2');
        cleaned = cleaned.replace(/\s+/g, ' ');
        cleaned = cleaned.trim();

        return cleaned;
      }

      // Process image with OCR
      async function processImageWithOCR(file) {
        isProcessingImage = true;
        solutionDiv.innerHTML = 'Processing image with OCR...';
        updateButtonStates();

        try {
          const { createWorker } = window.Tesseract;
          const worker = await createWorker('eng');

          const imageUrl = URL.createObjectURL(file);
          const { data: { text } } = await worker.recognize(imageUrl);

          await worker.terminate();
          URL.revokeObjectURL(imageUrl);

          const cleanedText = cleanOCRText(text);
          return cleanedText;
        } catch (error) {
          console.error('OCR Error:', error);
          throw new Error('Failed to process image. Please try again.');
        } finally {
          isProcessingImage = false;
          updateButtonStates();
        }
      }

      // Format solution
      function formatSolution(text) {
        text = text.replace(/###\s*(.*?)$/gm, '<h3 class="text-xl font-bold text-cyan-400 mt-6 mb-3">$1</h3>');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');

        text = text.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
          return `<div class="my-3 p-3 bg-cyan-900/20 rounded-lg border border-cyan-500/30 text-cyan-200 font-mono text-sm overflow-x-auto">${formula}</div>`;
        });

        text = text.replace(/\\\(([\s\S]*?)\\\)/g, (match, formula) => {
          return `<span class="inline-block px-2 py-1 bg-cyan-900/20 rounded text-cyan-200 font-mono text-sm mx-1">${formula}</span>`;
        });

        text = text.replace(/\\boxed\{([\s\S]*?)\}/g, (match, content) => {
          return `<div class="my-4 p-4 bg-gradient-to-r from-pink-900/30 to-cyan-900/30 rounded-xl border-2 border-pink-500/50 text-white font-bold text-center text-lg">${content}</div>`;
        });

        text = text.replace(/^--+$/gm, '<hr class="my-4 border-gray-600" />');

        const lines = text.split('\n');
        let formatted = '';
        let inList = false;

        for (let line of lines) {
          const trimmedLine = line.trim();

          if (trimmedLine.match(/^\d+\.\s+/)) {
            if (!inList) {
              formatted += '<ol class="list-decimal list-inside ml-4 space-y-3 my-4">';
              inList = true;
            }
            formatted += `<li class="ml-2 text-gray-200">${trimmedLine.replace(/^\d+\.\s+/, '')}</li>`;
          } else if (trimmedLine.startsWith('-') || trimmedLine.startsWith('•')) {
            if (!inList) {
              formatted += '<ul class="list-disc list-inside ml-4 space-y-2 my-3">';
              inList = true;
            }
            formatted += `<li class="ml-2 text-gray-200">${trimmedLine.substring(1).trim()}</li>`;
          } else {
            if (inList) {
              formatted += '</ol></ul>';
              inList = false;
            }
            if (trimmedLine && !trimmedLine.includes('<h3') && !trimmedLine.includes('<hr')) {
              formatted += `<p class="mb-2 text-gray-300 leading-relaxed">${trimmedLine}</p>`;
            } else if (trimmedLine.includes('<h3') || trimmedLine.includes('<hr') || trimmedLine.includes('<div')) {
              formatted += trimmedLine;
            }
          }
        }

        if (inList) {
          formatted += '</ol></ul>';
        }

        return formatted;
      }

      // Update button states
      function updateButtonStates() {
        const disabled = isLoading || isProcessingImage;
        submitBtn.disabled = disabled;
        refreshBtn.disabled = disabled;

        if (disabled) {
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
          refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }

      // Handle submit
      async function handleSubmit() {
        const inputQuestion = question.trim();
        if (!inputQuestion) {
          alert('Please enter a question or upload an image!');
          return;
        }

        isLoading = true;
        countdown = mode === 'image' ? 10 : 5;
        solutionDiv.innerHTML = 'Waiting for response...';
        submitBtn.textContent = `THINKING... (${countdown}s)`;
        updateButtonStates();

        // Start pencil animation immediately
        pencilEmoji.classList.add('animating');
        setTimeout(() => {
          pencilEmoji.classList.remove('animating');
        }, 5000);

        // Start countdown
        countdownInterval = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            submitBtn.textContent = `THINKING... (${countdown}s)`;
          } else {
            clearInterval(countdownInterval);
          }
        }, 1000);

        try {
          const prompt = `You are a helpful homework tutor. Solve this problem step-by-step in SIMPLE, EASY-TO-UNDERSTAND language.

IMPORTANT RULES:
- Use plain English explanations
- Break down each step clearly
- Avoid complex mathematical notation where possible
- When you must use formulas, explain what each symbol means
- Give a clear final answer at the end
- Keep it concise and to the point

Problem: ${inputQuestion}`;

          const pollinationsURL = `https://text.pollinations.ai/${encodeURIComponent(prompt)}`;

          const response = await fetch(pollinationsURL);
          const answer = await response.text();

          solutionDiv.innerHTML = formatSolution(answer);
        } catch (error) {
          console.error(error);
          solutionDiv.innerHTML = 'Error fetching answer. Please try again.';
        } finally {
          isLoading = false;
          countdown = 0;
          submitBtn.textContent = 'SUBMIT';
          if (countdownInterval) {
            clearInterval(countdownInterval);
          }
          updateButtonStates();
        }
      }

// Handle Refresh
      function handleRefresh() {
  question = '';
  selectedFile = null;
  solution = '';
  audioTranscript = '';
  questionInput.value = '';
  imageUpload.value = '';
  solutionDiv.innerHTML = '';
  uploadLabel.innerHTML = 'Drag & Drop or <span class="text-pink-400 underline">Upload Image</span>';
  extractedTextInfo.style.display = 'none';
  
  // Stop listening if active
  if (isListening) {
    stopListening();
  }
  
  // Reset audio display
  document.getElementById('transcriptText').textContent = '';
  document.getElementById('transcriptDisplay').style.display = 'none';
}


      // Mode switching
     textModeBtn.addEventListener('click', () => {
  mode = 'text';
  textModeBtn.classList.add('active-option');
  textModeBtn.classList.remove('bg-white/10', 'hover:bg-white/20');
  imageModeBtn.classList.remove('active-option');
  imageModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');
  audioModeBtn.classList.remove('active-option');  // ADD THIS LINE
  audioModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');  // ADD THIS LINE
  
  textInputContainer.style.display = 'block';
  imageInputContainer.style.display = 'none';
  audioInputContainer.style.display = 'none';  // ADD THIS LINE
  
  // Stop listening if active
  if (isListening) {
    stopListening();
  }
});


imageModeBtn.addEventListener('click', () => {
  mode = 'image';
  imageModeBtn.classList.add('active-option');
  imageModeBtn.classList.remove('bg-white/10', 'hover:bg-white/20');
  textModeBtn.classList.remove('active-option');
  textModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');
  audioModeBtn.classList.remove('active-option');  // ADD THIS LINE
  audioModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');  // ADD THIS LINE
  
  textInputContainer.style.display = 'none';
  imageInputContainer.style.display = 'block';
  audioInputContainer.style.display = 'none';  // ADD THIS LINE
  
  // Stop listening if active
  if (isListening) {
    stopListening();
  }
});


      // Text input
      questionInput.addEventListener('input', (e) => {
        question = e.target.value;
      });

      questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isLoading) {
          handleSubmit();
        }
      });

      // Image upload
      imageUpload.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (file) {
          selectedFile = file;
          uploadLabel.innerHTML = `<span class="text-cyan-400">Processing image...</span>`;

          try {
            const extractedText = await processImageWithOCR(file);
            question = extractedText;
            questionInput.value = extractedText;
            uploadLabel.innerHTML = `<span class="text-green-400">File selected: ${file.name}</span>`;
            extractedTextInfo.style.display = 'block';
            solutionDiv.innerHTML = `Extracted text: ${extractedText}\n\nClick SUBMIT to get the solution.`;
          } catch (error) {
            uploadLabel.innerHTML = 'Drag & Drop or <span class="text-pink-400 underline">Upload Image</span>';
            solutionDiv.innerHTML = 'Error processing image. Please try uploading a different image.';
          }
        }
      });

      // Submit and refresh buttons
      submitBtn.addEventListener('click', handleSubmit);
      refreshBtn.addEventListener('click', handleRefresh);
      
      
      // Add these variables at the top with your other state variables
let recognition = null;
let isListening = false;
let audioTranscript = '';

// Initialize Speech Recognition
function initializeSpeechRecognition() {
  // Check if browser supports speech recognition
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    recognition = new SpeechRecognition();
    
    // Configure recognition
    recognition.continuous = true;  // Keep listening until stopped
    recognition.interimResults = true;  // Show results as user speaks
    recognition.lang = 'en-US';  // Set language
    
    // Handle results
    recognition.onresult = (event) => {
      let finalTranscript = '';
      let interimTranscript = '';
      
      // Process all results
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript + ' ';
        } else {
          interimTranscript += transcript;
        }
      }
      
      // Update transcript if we have final results
      if (finalTranscript) {
        audioTranscript += finalTranscript;
        question += finalTranscript;
        document.getElementById('transcriptText').textContent = audioTranscript;
        document.getElementById('transcriptDisplay').style.display = 'block';
      }
    };
    
    // Handle errors
    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      stopListening();
      if (event.error === 'not-allowed') {
        alert('Microphone access denied. Please allow microphone access in your browser settings.');
      }
    };
    
    // Handle when recognition stops
    recognition.onend = () => {
      isListening = false;
      updateMicButton();
    };
  } else {
    console.warn('Speech recognition not supported in this browser');
  }
}

// Toggle listening on/off
function toggleListening() {
  if (!recognition) {
    alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
    return;
  }
  
  if (isListening) {
    stopListening();
  } else {
    startListening();
  }
}

// Start listening
function startListening() {
  audioTranscript = '';
  document.getElementById('transcriptText').textContent = '';
  document.getElementById('transcriptDisplay').style.display = 'none';
  
  try {
    recognition.start();
    isListening = true;
    updateMicButton();
  } catch (error) {
    console.error('Error starting recognition:', error);
  }
}

// Stop listening
function stopListening() {
  if (recognition && isListening) {
    recognition.stop();
    isListening = false;
    updateMicButton();
  }
}

// Update microphone button appearance
function updateMicButton() {
  const micButton = document.getElementById('micButton');
  const listeningStatus = document.getElementById('listeningStatus');
  
  if (isListening) {
    micButton.classList.add('listening-pulse');
    listeningStatus.innerHTML = '<span class="text-red-400 font-semibold">Listening... (Click to stop)</span>';
  } else {
    micButton.classList.remove('listening-pulse');
    listeningStatus.textContent = 'Click the microphone to start speaking';
  }
}

// Add event listener to audio mode button
document.getElementById('audioModeBtn').addEventListener('click', () => {
  mode = 'audio';
  
  // Update button styles
  audioModeBtn.classList.add('active-option');
  audioModeBtn.classList.remove('bg-white/10', 'hover:bg-white/20');
  textModeBtn.classList.remove('active-option');
  textModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');
  imageModeBtn.classList.remove('active-option');
  imageModeBtn.classList.add('bg-white/10', 'hover:bg-white/20');
  
  // Show/hide containers
  textInputContainer.style.display = 'none';
  imageInputContainer.style.display = 'none';
  audioInputContainer.style.display = 'block';
});

// Add event listener to microphone button
document.getElementById('micButton').addEventListener('click', toggleListening);

// Initialize speech recognition when page loads
initializeSpeechRecognition();

    </script>
  </body>
</html>
